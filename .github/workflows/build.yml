name: Build

on:
  push:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  update:
    name: Update
    runs-on: ubuntu-latest
    steps:
      - name: Update
        run: |
          #!/bin/bash
          repo="1f349/vaultwarden-binary"
          latestVersion="$(curl -q --fail 'https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest' | jq -r '.tag_name' -)"
          if gh release view "$latestVersion" --repo "$repo"; then
            exit 0
          fi
          docker pull --platform linux/amd64 vaultwarden/server:"$latestVersion"
          id="$(docker create vaultwarden/server:"$latestVersion")"
          docker cp "$id":/vaultwarden vaultwarden
          docker cp "$id":/web-vault web-vault
          docker rm -v "$id"
          tar -cvf vaultwarden.tar.gz vaultwarden web-vault
          gh release create "v$latestVersion" --repo "$repo" --notes "Update to [$latestVersion](https://github.com/dani-garcia/vaultwarden/releases/tag/$latestVersion" vaultwarden.tar.gz
        env:
          GH_TOKEN: ${{ github.token }}
